name: Build & Release (Windows)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 6.0.x

    - name: Publish DownKyi
      run: |
        dotnet publish DownKyi/DownKyi.csproj ^
          -c Release ^
          -r win-x64 ^
          --self-contained false ^
          -o publish

    - name: Download aria2
      run: |
        curl -L -o aria2.zip https://github.com/aria2/aria2/releases/latest/download/aria2-1.37.0-win-64bit-build1.zip
        tar -xf aria2.zip
        copy aria2*/aria2c.exe publish

    - name: Download ffmpeg
      run: |
        curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
        tar -xf ffmpeg.zip
        copy ffmpeg*/bin/ffmpeg.exe publish

    - name: Zip package
      run: |
        tar -a -c -f DownKyi-win-x64.zip publish

    - name: Publish GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: DownKyi-win-x64.zip
